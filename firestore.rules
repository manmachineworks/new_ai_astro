rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // Use custom claims if needed:
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isParticipant(chatId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantUids;
    }

    // Block writing PII keys anywhere
    function noPII() {
      // If you add more PII keys later, add them here.
      return !(('phone' in request.resource.data) ||
               ('email' in request.resource.data) ||
               ('phoneNumber' in request.resource.data) ||
               ('whatsapp' in request.resource.data));
    }

    // ----- Users (public-safe profile only) -----
    match /users/{uid} {
      allow read: if isSignedIn(); // or public read if you want
      allow create: if isOwner(uid) && noPII();
      allow update: if isOwner(uid) && noPII();
      allow delete: if false;
    }

    match /astrologers/{uid} {
      allow read: if true; // public listing safe fields only
      allow create: if isOwner(uid) && noPII();
      allow update: if isOwner(uid) && noPII();
      allow delete: if false;
    }

    // ----- Chats -----
    match /chats/{chatId} {
      allow read: if isParticipant(chatId) || isAdmin();

      // Create chat: only if creator is one of participants & no PII
      allow create: if isSignedIn()
        && noPII()
        && request.auth.uid in request.resource.data.participantUids
        && request.resource.data.participantUids.size() == 2;

      // Update chat metadata (lastMessage, status, pricing badges):
      allow update: if isParticipant(chatId)
        && noPII()
        // Prevent client from changing participants
        && request.resource.data.participantUids == resource.data.participantUids;

      allow delete: if false;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isParticipant(chatId) || isAdmin();

        // Create message: only sender can create; validate fields
        allow create: if isParticipant(chatId)
          && request.resource.data.senderUid == request.auth.uid
          && request.resource.data.createdAt is timestamp
          && request.resource.data.type in ['text', 'image', 'file', 'voice']
          && noPII();

        // Updates: allow only read receipts/reactions, no editing content
        allow update: if isParticipant(chatId)
          && noPII()
          // Lock message body fields from changes:
          && request.resource.data.text == resource.data.text
          && request.resource.data.senderUid == resource.data.senderUid
          && request.resource.data.type == resource.data.type
          && request.resource.data.createdAt == resource.data.createdAt;

        allow delete: if false;
      }
    }

    // ----- Presence -----
    match /presence/{uid} {
      allow read: if isSignedIn(); // or public if you want "online" public
      allow create: if isOwner(uid) && noPII();
      allow update: if isOwner(uid) && noPII();
      allow delete: if false;
    }

    // ----- Typing -----
    match /typing/{chatId}/{uid} {
      allow read: if isParticipant(chatId);
      allow create, update: if isOwner(uid) && isParticipant(chatId);
      allow delete: if isOwner(uid);
    }
  }
}
